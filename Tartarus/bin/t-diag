#!/usr/bin/python
from Tartarus.system import check, krbconf
import sys, os, tempfile
from Tartarus.client import initialize



def _make_tmpfile(realm, kdc):
    tmp = tempfile.TemporaryFile()
    _sections = krbconf.CfgReader()(tmp.read())
    d = _sections.section('libdefaults')
    d.setTag('default_realm', realm)
    s = _sections.section('realms')
    val = krbconf.Subsection()
    val.setTag('kdc', kdc)
    val.setTag('admin_server', kdc)
    s.setTag('realm', val)
    tmp.write(str(_sections))
    tmp.seek(0)
    getpath = tempfile.mkstemp()
    path = getpath[1]
    os.environ['KRB5_CONFIG']=path

def main():
    sys.stdout.write("\nCheck of host and domain: ")
    success, error = check.check_host_domain()
    if (error == []):
        sys.stdout.write('\033[92mDONE\033[0m\n')
    else:
        sys.stdout.write('\033[91mFAIL\033[0m\n')

    for i in success:
        if i.split()[0].startswith("Domain"):
            domain = i.split()[1]
        sys.stdout.write('\t%s\n' % i)
    if (error != []):
        for y in error:
            sys.stdout.write('\t%s\n' % y)

    _make_tmpfile("SARATOV.ETERSOFT.RU", "kerberos.saratov.etersoft.ru")
    comm, argv = initialize('deploy', domain= domain)

    sys.stdout.write("\nCheck of DNS: ")
    success, error = check.check_DNS(comm)
    if (error == []):
        sys.stdout.write('\033[92mDONE\033[0m\n')
    else:
        sys.stdout.write('\033[91mFAIL\033[0m\n')
    for i in success:
        sys.stdout.write('\t%s\n' % i)
    if (error != []):
        for y in error:
            sys.stdout.write('\t%s\n' % y)

    sys.stdout.write("\nCheck of kerberos: ")
    success, error = check.check_krb5_lookup()
    if (error == []):
        sys.stdout.write('\033[92mDONE\033[0m\n')
    else:
        sys.stdout.write('\033[91mFAIL\033[0m\n')
    for i in success:
        sys.stdout.write('\t%s\n' % i)
    if (error != []):
        for y in error:
            sys.stdout.write('\t%s\n' % y)

    sys.stdout.write("\nCheck of time on server and localtime: ")
    success, error = check.check_Time(comm)
    if (error == []):
        sys.stdout.write('\033[92mDONE\033[0m\n')
    else:
        sys.stdout.write('\033[91mFAIL\033[0m\n')
    for i in success:
        sys.stdout.write('\t%s\n' % i)
    if (error != []):
        for y in error:
            sys.stdout.write('\t%s\n' % y)
if __name__ == '__main__':
    main()
